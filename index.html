<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000000;
        }
        .lcars-panel {
            background-color: #55446f;
            border-radius: 2rem;
            box-shadow: none;
            border: 2px solid #a37dfd;
        }
        .lcars-panel-create {
            background-color: #03a9f4;
            border-color: #81d4fa;
        }
        .lcars-text {
            color: #ff9100;
        }
        .lcars-text-create {
            color: #ffffff;
        }
        .lcars-btn {
            background-color: #f57c00;
            color: white;
            border-radius: 1.5rem;
            transition-property: background-color;
            transition-duration: 300ms;
        }
        .lcars-btn:hover {
            background-color: #ef6c00;
        }
        .lcars-btn-create {
            background-color: #55446f;
            color: #ff9100;
            border-radius: 1.5rem;
            transition-property: background-color;
            transition-duration: 300ms;
        }
        .lcars-btn-create:hover {
            background-color: #4b3d68;
        }
        .lcars-input {
            background-color: #4b3d68;
            color: #fff;
            border-color: #a37dfd;
            border-radius: 1rem;
            box-shadow: none;
        }
        .lcars-input-create {
            background-color: #0288d1;
            border-color: #81d4fa;
            color: white;
        }
        .lcars-input:focus {
            border-color: #ff9100;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 145, 0, 0.5);
        }
        .lcars-tab-button {
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            color: #a37dfd;
            background-color: #4b3d68;
        }
        .lcars-tab-button.active {
            color: #ff9100;
            background-color: #55446f;
            border-bottom: 2px solid #ff9100;
            font-weight: 700;
        }
        .calendar-day.has-appointment {
            background-color: #ff9100;
            color: #211531;
            font-weight: bold;
        }
        /* Estilos para el modal personalizado */
        .custom-modal {
            background-color: #55446f;
            border-radius: 2rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid #a37dfd;
        }
        /* New Patient Form scrollable section */
        #newPatientFormScroll {
            max-height: 70vh; /* Adjust as needed */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #a37dfd #4b3d68;
        }
        #newPatientFormScroll::-webkit-scrollbar {
            width: 8px;
        }
        #newPatientFormScroll::-webkit-scrollbar-track {
            background: #4b3d68;
        }
        #newPatientFormScroll::-webkit-scrollbar-thumb {
            background-color: #a37dfd;
            border-radius: 20px;
            border: 2px solid #4b3d68;
        }
        
        .blink {
            animation: blink-animation 1s infinite;
        }

        @keyframes blink-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Estilos para la nueva consola */
        .lcars-console {
            background-color: #2b2b2b; /* Fondo oscuro */
            border: 2px solid #00ffff; /* Borde cian brillante */
            color: #00ff00; /* Texto verde neon */
            font-size: 0.75rem; /* text-xs */
            font-family: 'Roboto Mono', monospace;
            padding: 0.5rem;
            border-radius: 0.75rem;
            max-height: 80px;
            overflow-y: auto;
            white-space: pre-wrap;
            scrollbar-width: thin;
            scrollbar-color: #00ffff #2b2b2b;
        }
        .lcars-console::-webkit-scrollbar {
            width: 8px;
        }
        .lcars-console::-webkit-scrollbar-track {
            background: #2b2b2b;
        }
        .lcars-console::-webkit-scrollbar-thumb {
            background-color: #00ffff;
            border-radius: 20px;
            border: 2px solid #2b2b2b;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-center">

    <!-- Modal de confirmación para eliminar paciente -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 overflow-auto bg-gray-800 bg-opacity-75 flex items-center justify-center">
        <div class="custom-modal p-6 w-full max-w-sm mx-auto">
            <h3 class="text-lg font-bold text-[#ff9100] mb-4">Confirmar Eliminación</h3>
            <p class="text-[#a37dfd] mb-6">¿Estás seguro de que quieres eliminar a este paciente? Esta acción es irreversible.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteBtn" class="bg-[#6b588a] text-white rounded-xl py-2 px-4 hover:bg-[#8369a1] transition-colors">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-[#f57c00] text-white rounded-xl py-2 px-4 hover:bg-[#ef6c00] transition-colors">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para mensajes de alerta y confirmación personalizados -->
    <div id="messageModal" class="hidden fixed inset-0 z-50 overflow-auto bg-gray-800 bg-opacity-75 flex items-center justify-center">
        <div class="custom-modal p-6 w-full max-w-sm mx-auto">
            <h3 id="messageTitle" class="text-lg font-bold text-[#ff9100] mb-4"></h3>
            <p id="messageContent" class="text-[#a37dfd] mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="messageOkBtn" class="bg-[#f57c00] text-white rounded-xl py-2 px-4 hover:bg-[#ef6c00] transition-colors">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agendar Cita -->
    <div id="appointmentModal" class="hidden fixed inset-0 z-50 overflow-auto bg-gray-800 bg-opacity-75 flex items-center justify-center">
        <div class="custom-modal p-6 w-full max-w-sm mx-auto">
            <h3 class="text-lg font-bold text-[#ff9100] mb-4">Agendar Cita</h3>
            <p class="text-[#a37dfd] mb-4">Selecciona un paciente y una fecha para agendar la cita.</p>
            <form id="appointmentForm" class="space-y-4">
                <input type="text" id="appointmentPatientInput" placeholder="Nombre completo del paciente" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]" list="patientSuggestions">
                <input type="date" id="appointmentDateInput" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancelAppointmentBtn" class="bg-[#6b588a] text-white rounded-xl py-2 px-4 hover:bg-[#8369a1] transition-colors">Cancelar</button>
                    <button type="submit" id="saveAppointmentBtn" class="bg-[#f57c00] text-white rounded-xl py-2 px-4 hover:bg-[#ef6c00] transition-colors">Agendar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="loadingIndicator" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-cyan-400"></div>
    </div>

    <!-- PANTALLA DE INICIO DE SESIÓN -->
    <div id="authPanel" class="w-full max-w-sm lcars-panel p-6 flex flex-col items-center">
        <div id="logo-3d-container" class="w-48 h-24"></div>
        <h1 class="text-3xl font-bold lcars-text mt-[120px] mb-6 text-center">Gestión de Pacientes<br>Juan David Caicedo Narváez, MD.</h1>
        <h2 id="authTitle" class="text-xl font-semibold mb-4 text-[#a37dfd] text-center">Iniciar Sesión</h2>
        <form id="authForm" class="space-y-4 w-full">
            <input type="email" id="emailInput" placeholder="Correo Electrónico" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
            <input type="password" id="passwordInput" placeholder="Contraseña" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
            <div id="authError" class="text-red-400 text-center hidden"></div>
            <button type="submit" id="authBtn" class="w-full lcars-btn text-lg font-semibold py-2 transition-colors">
                Iniciar Sesión
            </button>
        </form>
        <button id="toggleAuthBtn" class="w-full text-center mt-4 text-[#a37dfd] hover:text-[#ff9100] transition-colors text-sm">
            Crear cuenta
        </button>
        <button id="forgotPasswordBtn" class="w-full text-center mt-2 text-[#a37dfd] hover:text-[#ff9100] transition-colors text-sm">
            ¿Olvidaste tu contraseña?
        </button>
    </div>

    <!-- CONTENIDO PRINCIPAL DE LA APLICACIÓN (OCULTO POR DEFECTO) -->
    <div id="mainPanel" class="w-full max-w-4xl p-6 hidden">
        <div class="lcars-panel-create p-6">
            <div class="flex flex-col md:flex-row items-center justify-between mb-6 border-b-2 pb-2 border-[#81d4fa] md:space-x-4">
                <div class="flex items-center space-x-4 flex-1">
                    <div class="w-40 h-24 bg-transparent">
                        <!-- Contenedor para la nueva consola -->
                        <pre id="consoleOutput" class="lcars-console h-full"></pre>
                    </div>
                    <h1 class="text-3xl font-bold lcars-text text-center">Gestión de Pacientes</h1>
                </div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <button id="toggleConsoleBtn" class="lcars-btn-create text-white font-semibold py-2 px-4 transition-colors">
                        Detener Consola
                    </button>
                    <p id="userIdDisplay" class="text-sm text-[#ffffff] break-all"></p>
                    <button id="logoutBtn" class="lcars-btn-create text-white font-semibold py-2 px-4 hover:bg-[#4b3d68] transition-colors">
                        Cerrar Sesión
                    </button>
                </div>
            </div>

            <!-- Barra de navegación por pestañas -->
            <div class="flex justify-center mb-6">
                <button id="tabPatientsBtn" class="lcars-tab-button active py-2 px-6 transition-colors duration-300">Mis Pacientes</button>
                <button id="tabCalendarBtn" class="lcars-tab-button py-2 px-6 transition-colors duration-300">Calendario</button>
                <button id="tabNewPatientBtn" class="lcars-tab-button py-2 px-6 transition-colors duration-300">Nuevo Paciente</button>
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <!-- Contenedor para el contenido de las pestañas -->
                <div id="tabContent" class="flex-1">

                    <!-- Panel de Lista de Pacientes -->
                    <div id="patientsPanel" class="lcars-panel p-4">
                        <h2 class="text-xl font-semibold mb-4 lcars-text">Mis Pacientes</h2>
                        
                        <!-- Barra de búsqueda con sugerencias -->
                        <input type="text" id="searchInput" placeholder="Buscar por nombre o ciudad..." list="patientSuggestions" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100] mb-4">
                        <datalist id="patientSuggestions"></datalist>

                        <div class="space-y-2 mb-4">
                            <button id="downloadAllPatientsBtn" class="w-full bg-cyan-600 text-white rounded-xl py-2 px-4 hover:bg-cyan-700 transition-colors shadow-md">
                                Descargar Todos los Pacientes (.csv)
                            </button>
                        </div>
                        <ul id="patientList" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Los pacientes se cargarán aquí -->
                        </ul>
                    </div>

                    <!-- Panel de Calendario (Oculto por defecto) -->
                    <div id="calendarPanel" class="lcars-panel p-4 hidden">
                        <h2 class="text-xl font-semibold mb-4 lcars-text">Citas del mes</h2>
                        <div class="w-full flex justify-between items-center mb-4">
                            <button id="prevMonthBtn" class="text-[#a37dfd] hover:text-[#ff9100] transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <span id="currentMonthYear" class="text-lg font-bold text-white"></span>
                            <button id="nextMonthBtn" class="text-[#a37dfd] hover:text-[#ff9100] transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                        <div class="w-full grid grid-cols-7 text-center text-xs text-[#a37dfd] mb-2">
                            <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                        </div>
                        <div id="calendarGrid" class="w-full grid grid-cols-7 gap-1 text-center text-white">
                            <!-- Días del calendario se renderizarán aquí -->
                        </div>
                        <button id="addAppointmentFromCalendarBtn" class="w-full lcars-btn text-sm font-semibold py-2 mt-4 transition-colors shadow-md text-white">
                                Agendar Cita
                        </button>
                    </div>

                    <!-- Formulario de Nuevo Paciente (Oculto por defecto) -->
                    <div id="newPatientFormPanel" class="lcars-panel p-4 hidden">
                        <h2 id="formTitle" class="text-xl font-semibold mb-4 lcars-text">Añadir Nuevo Paciente</h2>
                        <div id="newPatientFormScroll">
                            <form id="newPatientForm" class="space-y-4">
                                <input type="text" id="patientNameInput" placeholder="Nombre" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                <input type="text" id="patientLastNameInput" placeholder="Apellido" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                <div class="flex items-center space-x-2">
                                    <input type="date" id="patientDobInput" required class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                    <span id="patientAgeDisplay" class="text-sm text-[#a37dfd] w-1/4 min-w-[70px] text-right"></span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="patientAddressInput" placeholder="Dirección" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                    <input type="text" id="patientCityInput" placeholder="Ciudad de Residencia" list="cities" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                </div>
                                
                                <input type="text" id="patientContactInput" placeholder="Número de Contacto" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                <input type="text" id="patientBirthplaceInput" placeholder="Lugar de Nacimiento" list="cities" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                                
                                <!-- NUEVA SECCIÓN DE ANTECEDENTES (COLAPSABLE) -->
                                <div>
                                    <button type="button" id="toggleHistoryBtn" class="w-full text-left bg-[#4b3d68] text-[#ff9100] font-semibold py-2 px-4 rounded-xl shadow-md flex items-center justify-between transition-colors hover:bg-[#5a4970]">
                                        <span>Antecedentes</span>
                                        <svg id="historyArrow" class="h-6 w-6 transform transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </button>
                                    <div id="historySection" class="space-y-4 mt-4 hidden">
                                        <div class="bg-[#4b3d68] p-4 rounded-3xl border-2 border-[#a37dfd]">
                                            <h4 class="text-md font-semibold text-[#ff9100] mb-2">Patológicos</h4>
                                            <textarea id="patientPathologicalHistoryInput" placeholder="Antecedentes patológicos" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                        </div>
                                        <div class="bg-[#4b3d68] p-4 rounded-3xl border-2 border-[#a37dfd]">
                                            <h4 class="text-md font-semibold text-[#ff9100] mb-2">Familiares</h4>
                                            <textarea id="patientFamilyHistoryInput" placeholder="Antecedentes familiares" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                        </div>
                                        <div class="bg-[#4b3d68] p-4 rounded-3xl border-2 border-[#a37dfd]">
                                            <h4 class="text-md font-semibold text-[#ff9100] mb-2">Farmacológicos</h4>
                                            <textarea id="patientPharmacologicalHistoryInput" placeholder="Antecedentes farmacológicos" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                        </div>
                                        <div class="bg-[#4b3d68] p-4 rounded-3xl border-2 border-[#a37dfd]">
                                            <h4 class="text-md font-semibold text-[#ff9100] mb-2">Quirúrgicos</h4>
                                            <textarea id="patientSurgicalHistoryInput" placeholder="Antecedentes quirúrgicos" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <textarea id="patientCurrentIllnessInput" placeholder="Enfermedad Actual" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                <textarea id="patientTreatmentsInput" placeholder="Tratamientos" class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                <textarea id="patientAnalysisInput" placeholder="Análisis" class="w-full p-2 border-2 lcars-input resize-none focus:outline-none focus:ring-2 focus:ring-[#ff9100]"></textarea>
                                <div class="flex justify-end space-x-2 mt-4">
                                    <button type="button" id="cancelNewPatientBtn" class="bg-[#6b588a] text-white rounded-xl py-2 px-4 hover:bg-[#8369a1] transition-colors shadow-md">
                                        Cancelar
                                    </button>
                                    <button type="submit" id="savePatientBtn" class="lcars-btn text-white rounded-xl py-2 px-4 transition-colors shadow-md">
                                        Guardar Paciente
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>

                <!-- Panel Principal de Paciente (Siempre a la derecha, oculto por defecto) -->
                <div id="patientDetailsPanel" class="flex-1 lcars-panel p-4 hidden">
                    <div class="flex items-center justify-between mb-4 border-b-2 pb-2 border-[#a37dfd]">
                        <div class="flex-grow">
                            <h2 id="patientName" class="text-2xl font-bold lcars-text"></h2>
                        </div>
                        <div class="flex space-x-2">
                            <button id="editPatientBtn" class="text-[#03a9f4] hover:text-[#0288d1] transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button id="deletePatientBtn" class="text-[#f57c00] hover:text-[#ef6c00] transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <button id="downloadSinglePatientBtn" class="text-cyan-400 hover:text-cyan-500 transition-colors">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    </div>

                    <!-- SECCIÓN DE RESUMEN RÁPIDO -->
                    <div id="aiQuickSummarySection" class="bg-[#4b3d68] p-4 rounded-3xl shadow-inner mb-6 border-2 border-[#a37dfd]">
                        <h3 class="text-xl font-bold text-[#ff9100] mb-2">Resumen Rápido del Caso</h3>
                        <div id="aiQuickSummary" class="text-white whitespace-pre-wrap">
                            <p class="text-cyan-400 italic">Generando resumen...</p>
                        </div>
                    </div>
                    
                    <div id="notesSection" class="mb-6">
                        <h3 class="text-xl font-semibold text-[#ff9100] mb-2">Notas</h3>
                        <div id="patientNotes" class="bg-[#4b3d68] p-4 rounded-3xl shadow-sm space-y-4 max-h-60 overflow-y-auto border-2 border-[#a37dfd]">
                            <!-- Las notas se cargarán aquí -->
                        </div>
                        <div class="mt-4 flex flex-col space-y-2">
                            <textarea id="newNoteInput" placeholder="Añade una nueva nota..." class="w-full p-2 border-2 lcars-input resize-none focus:ring-2 focus:ring-[#ff9100] text-white"></textarea>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="priorityNoteCheckbox" class="rounded text-[#f57c00] focus:ring-[#f57c00]">
                                <label for="priorityNoteCheckbox" class="text-sm text-[#a37dfd]">Marcar como nota prioritaria</label>
                            </div>
                            <button id="addNoteBtn" class="w-full bg-[#03a9f4] text-white rounded-xl py-2 transition-colors shadow-md">
                                Añadir Nota
                            </button>
                        </div>
                    </div>

                    <div id="attachmentsSection" class="mb-6">
                        <h3 class="text-xl font-semibold text-[#ff9100] mb-2">Archivos Adjuntos</h3>
                        <div id="patientAttachments" class="bg-[#4b3d68] p-4 rounded-3xl shadow-sm space-y-2 max-h-40 overflow-y-auto border-2 border-[#a37dfd]">
                            <!-- Los archivos se cargarán aquí -->
                        </div>
                        <div class="mt-4 flex flex-col space-y-2">
                            <input type="file" id="attachmentFileInput" class="w-full p-2 border-2 lcars-input focus:ring-2 focus:ring-[#ff9100]">
                            <button id="addAttachmentBtn" class="w-full bg-[#673ab7] text-white rounded-xl py-2 hover:bg-[#5e35b1] transition-colors shadow-md">
                                Subir Archivo
                            </button>
                            <div id="uploadProgress" class="hidden w-full bg-[#4b3d68] rounded-full h-2.5 mt-2">
                                <div id="progressBar" class="bg-[#ff9100] h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="appointmentsSection" class="mb-6">
                        <h3 class="text-xl font-semibold text-[#ff9100] mb-2">Citas agendadas</h3>
                        <div id="patientAppointments" class="bg-[#4b3d68] p-4 rounded-3xl shadow-sm space-y-2 max-h-40 overflow-y-auto border-2 border-[#a37dfd]">
                            <!-- Las citas se cargarán aquí -->
                        </div>
                        <button id="addAppointmentFromPatientBtn" class="w-full bg-[#673ab7] text-white rounded-xl py-2 hover:bg-[#5e35b1] transition-colors shadow-md mt-4">
                            Agendar Cita para este Paciente
                        </button>
                    </div>


                    <div class="mb-6 space-y-2">
                        <button id="generateClinicalSummaryBtn" class="w-full lcars-btn text-white rounded-xl py-2 transition-colors shadow-md">
                            Generar Resumen Clínico con IA
                        </button>
                        <button id="generatePatientSummaryBtn" class="w-full bg-[#ff9100] text-white rounded-xl py-2 transition-colors shadow-md">
                            Generar Resumen para el Paciente ✨
                        </button>
                    </div>

                    <div id="aiClinicalSummarySection" class="hidden">
                        <h3 class="text-xl font-bold text-[#ff9100] mb-2">Resumen Clínico (IA)</h3>
                        <div id="aiClinicalSummary" class="bg-[#4b3d68] p-4 rounded-3xl shadow-sm text-white whitespace-pre-wrap">
                            <!-- El resumen de la IA se mostrará aquí -->
                        </div>
                    </div>

                    <!-- DATOS DEL PACIENTE AHORA EN LA PARTE INFERIOR -->
                    <div id="patientInfo" class="text-[#a37dfd] mt-1 p-4 bg-[#4b3d68] rounded-3xl shadow-sm">
                        <!-- Los datos del paciente se cargarán aquí -->
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    
    <!-- Datalist para las ciudades -->
    <datalist id="cities">
        <option value="Bogotá">
        <option value="Medellín">
        <option value="Cali">
        <option value="Barranquilla">
        <option value="Cartagena">
        <option value="Bucaramanga">
        <option value="Manizales">
        <option value="Pereira">
        <option value="Cúcuta">
        <option value="Ibagué">
        <option value="Santa Marta">
        <option value="Villavicencio">
        <option value="Pasto">
        <option value="Popayán">
        <option value="Tunja">
        <option value="Neiva">
        <option value="Sincelejo">
        <option value="Montería">
        <option value="San Andrés">
        <option value="Florencia">
        <option value="Armenia">
        <option value="Quibdó">
        <option value="Riohacha">
        <option value="Valledupar">
        <option value="Mocoa">
        <option value="Yopal">
        <option value="Puerto Carreño">
        <option value="San José del Guaviare">
        <option value="Mitú">
        <option value="Inírida">
        <option value="Leticia">
        <option value="Quito">
        <option value="Lima">
        <option value="Buenos Aires">
        <option value="Ciudad de México">
        <option value="Madrid">
        <option value="Miami">
        <option value="Los Angeles">
        <option value="Londres">
    </datalist>

    <!-- Three.js SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, onSnapshot, updateDoc, deleteDoc, query, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // REEMPLAZA ESTO CON TUS CREDENCIALES DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyDXLi2seXlLz-JyOMB_gY68m-7qDx7bssU",
          authDomain: "patients-jdcn-app.firebaseapp.com",
          projectId: "patients-jdcn-app",
          storageBucket: "patients-jdcn-app.firebasestorage.app",
          messagingSenderId: "5231907336",
          appId: "1:5231907336:web:58961f63cc4eaf1f1df7bd",
          measurementId: "G-F8LX06SG7N"
        };
        const geminiApiKey = 'AIzaSyDuSnH8UDUXaxlkOkWQMEeMDmtfCISJYd0';

        let db, auth, storage, userId;
        const patientsRef = (uid) => collection(db, `artifacts/${appId}/users/${uid}/patients`);
        
        // UI elements
        const authPanel = document.getElementById('authPanel');
        const mainPanel = document.getElementById('mainPanel');
        const authForm = document.getElementById('authForm');
        const authTitleEl = document.getElementById('authTitle');
        const authBtn = document.getElementById('authBtn');
        const toggleAuthBtn = document.getElementById('toggleAuthBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authErrorEl = document.getElementById('authError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const searchInput = document.getElementById('searchInput');
        const patientSuggestionsEl = document.getElementById('patientSuggestions');
        const patientListEl = document.getElementById('patientList');
        const patientDetailsPanel = document.getElementById('patientDetailsPanel');
        const newPatientFormPanel = document.getElementById('newPatientFormPanel');
        const patientsPanel = document.getElementById('patientsPanel');
        const calendarPanel = document.getElementById('calendarPanel');
        const tabPatientsBtn = document.getElementById('tabPatientsBtn');
        const tabCalendarBtn = document.getElementById('tabCalendarBtn');
        const tabNewPatientBtn = document.getElementById('tabNewPatientBtn');
        const cancelNewPatientBtn = document.getElementById('cancelNewPatientBtn');
        const newPatientForm = document.getElementById('newPatientForm');
        const formTitleEl = document.getElementById('formTitle');
        const savePatientBtn = document.getElementById('savePatientBtn');
        const patientNameInput = document.getElementById('patientNameInput');
        const patientLastNameInput = document.getElementById('patientLastNameInput');
        const patientDobInput = document.getElementById('patientDobInput');
        const patientAgeDisplay = document.getElementById('patientAgeDisplay');
        const patientAddressInput = document.getElementById('patientAddressInput');
        const patientCityInput = document.getElementById('patientCityInput');
        const patientContactInput = document.getElementById('patientContactInput');
        const patientBirthplaceInput = document.getElementById('patientBirthplaceInput');
        const patientPathologicalHistoryInput = document.getElementById('patientPathologicalHistoryInput');
        const patientFamilyHistoryInput = document.getElementById('patientFamilyHistoryInput');
        const patientPharmacologicalHistoryInput = document.getElementById('patientPharmacologicalHistoryInput');
        const patientSurgicalHistoryInput = document.getElementById('patientSurgicalHistoryInput');
        const patientCurrentIllnessInput = document.getElementById('patientCurrentIllnessInput');
        const patientTreatmentsInput = document.getElementById('patientTreatmentsInput');
        const patientAnalysisInput = document.getElementById('patientAnalysisInput');
        const patientNameEl = document.getElementById('patientName');
        const patientInfoEl = document.getElementById('patientInfo');
        const patientNotesEl = document.getElementById('patientNotes');
        const newNoteInput = document.getElementById('newNoteInput');
        const priorityNoteCheckbox = document.getElementById('priorityNoteCheckbox');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const closePatientBtn = document.getElementById('closePatientBtn');
        const editPatientBtn = document.getElementById('editPatientBtn');
        const deletePatientBtn = document.getElementById('deletePatientBtn');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const aiQuickSummarySection = document.getElementById('aiQuickSummarySection');
        const aiQuickSummaryEl = document.getElementById('aiQuickSummary');
        const patientAttachmentsEl = document.getElementById('patientAttachments');
        const attachmentFileInput = document.getElementById('attachmentFileInput');
        const addAttachmentBtn = document.getElementById('addAttachmentBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const generateClinicalSummaryBtn = document.getElementById('generateClinicalSummaryBtn');
        const generatePatientSummaryBtn = document.getElementById('generatePatientSummaryBtn');
        const aiClinicalSummarySection = document.getElementById('aiClinicalSummarySection');
        const aiPatientSummarySection = document.getElementById('aiPatientSummarySection');
        const aiPatientSummaryEl = document.getElementById('aiPatientSummary');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const addAppointmentFromCalendarBtn = document.getElementById('addAppointmentFromCalendarBtn');
        const patientAppointmentsEl = document.getElementById('patientAppointments');
        const addAppointmentFromPatientBtn = document.getElementById('addAppointmentFromPatientBtn');
        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');
        const messageOkBtn = document.getElementById('messageOkBtn');
        const appointmentModal = document.getElementById('appointmentModal');
        const appointmentForm = document.getElementById('appointmentForm');
        const appointmentPatientInput = document.getElementById('appointmentPatientInput');
        const appointmentDateInput = document.getElementById('appointmentDateInput');
        const cancelAppointmentBtn = document.getElementById('cancelAppointmentBtn');
        const downloadSinglePatientBtn = document.getElementById('downloadSinglePatientBtn');
        const downloadAllPatientsBtn = document.getElementById('downloadAllPatientsBtn');
        const historySection = document.getElementById('historySection');
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const historyArrow = document.getElementById('historyArrow');
        const attachFileInput = document.getElementById('attachmentFileInput');
        const toggleConsoleBtn = document.getElementById('toggleConsoleBtn');
        
        let patients = [];
        let selectedPatientId = null;
        let isEditing = false;
        let isLoginState = true;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let consoleIntervalId = null;

        // Custom Modal functions
        function showMessageModal(title, message) {
            messageTitle.textContent = title;
            messageContent.textContent = message;
            messageModal.classList.remove('hidden');
        }

        messageOkBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Function to create and animate the 3D logo
        function createAndAnimateLogo(container, isMainLogo = false) {
            const width = isMainLogo ? 80 : 180;
            const height = isMainLogo ? 80 : 90;
            const cylinderRadius = isMainLogo ? 0.9 : 1.5;
            const cylinderHeight = isMainLogo ? 0.15 : 0.3;
            const scaleX = isMainLogo ? 1.0 : 2.5; 
            const scaleZ = isMainLogo ? 1.0 : 1.0; 
            const textScale = isMainLogo ? 100 : 180;
            const cameraZ = isMainLogo ? 2.0 : 6;
            const textY = isMainLogo ? 0 : 0;
            
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // Create a canvas for the texture
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const context = canvas.getContext('2d');
            
            if (isMainLogo) {
                // Símbolo de Esculapio para el logo principal
                const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path fill="#000000" d="M16 32h24l62.062 136.53L106.182 176c11.018 0 20.472 6.942 24.318 16.924L168 320h-48L85.818 200c-3.846-10.038-1.523-21.41 5.922-28.784L128 128h-32c-17.673 0-32 14.327-32 32v16H16V32zM320 32h-16c-17.673 0-32 14.327-32 32v256c0 17.673 14.327 32 32 32h16c17.673 0 32-14.327 32-32V64c0-17.673-14.327-32-32-32zm160-32H400c-17.673 0-32 14.327-32 32v256c0 17.673 14.327 32 32 32h16c17.673 0 32-14.327 32-32V32c0-17.673-14.327-32-32-32z"/></svg>`;
                const svgBlob = new Blob([svgContent], {type: 'image/svg+xml'});
                const svgUrl = URL.createObjectURL(svgBlob);
                const img = new Image();
                img.onload = () => {
                    context.fillStyle = isMainLogo ? '#ff9100' : '#ff9100'; // Fondo del logo principal
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(img, 0, 0, canvas.width, canvas.height);
                    texture.needsUpdate = true;
                };
                img.src = svgUrl;
                
            } else {
                context.fillStyle = '#ff9100';
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.fillStyle = '#ffffff'; 
                context.font = `bold ${textScale}px Roboto Mono`;
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.save();
                context.translate(canvas.width / 2, canvas.height / 2);
                context.rotate(3 * Math.PI / 2); // Rota el texto 270 grados
                context.fillText('JDCN', 0, 0);
                context.restore();
            }

            const texture = new THREE.CanvasTexture(canvas);

            const coinGeometry = new THREE.CylinderGeometry(cylinderRadius, cylinderRadius, cylinderHeight, 64);
            const coinMaterial = [
                new THREE.MeshStandardMaterial({ color: '#c49a37', metalness: 0.8, roughness: 0.4 }),
                new THREE.MeshStandardMaterial({ map: texture }),
                new THREE.MeshStandardMaterial({ map: texture }),
            ];
            const coin = new THREE.Mesh(coinGeometry, coinMaterial);
            coin.scale.set(scaleX, 1.0, scaleZ);
            
            // Set initial rotation to make the logo visible
            coin.rotation.x = Math.PI / 2;
            coin.position.y = isMainLogo ? -0.5 : -1.0;
            scene.add(coin);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1.5, 100);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            camera.position.z = cameraZ;

            function animate() {
                if (!container.closest('body')) return; // Stop animation if container is removed
                requestAnimationFrame(animate);
                // Rotate the coin on the Z-axis for a flat, spinning effect
                coin.rotation.z += 0.005;
                renderer.render(scene, camera);
            }
            animate();
        }
        
        // Función para generar una línea de datos aleatoria
        function generateRandomLine() {
            const types = ['binary', 'hex', 'alphanumeric'];
            const type = types[Math.floor(Math.random() * types.length)];
            let line = '';
            const length = 50 + Math.floor(Math.random() * 50);

            switch(type) {
                case 'binary':
                    for (let i = 0; i < length; i++) {
                        line += Math.round(Math.random());
                    }
                    line = '0b' + line;
                    break;
                case 'hex':
                    const hexChars = '0123456789abcdef';
                    for (let i = 0; i < length / 2; i++) {
                        line += hexChars[Math.floor(Math.random() * hexChars.length)];
                    }
                    line = '0x' + line;
                    break;
                case 'alphanumeric':
                    const alphaChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+=-`~';
                    for (let i = 0; i < length; i++) {
                        line += alphaChars[Math.floor(Math.random() * alphaChars.length)];
                    }
                    break;
            }
            return line;
        }

        // Función para agregar una línea a la consola y hacer scroll
        function addLine() {
            const consoleOutput = document.getElementById('consoleOutput');
            const newLine = generateRandomLine();
            const textNode = document.createTextNode(newLine + '\n');
            consoleOutput.appendChild(textNode);
            // Hacer scroll hasta el final para ver la nueva línea
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Inicia la generación de líneas
        function startConsole() {
            if (consoleIntervalId === null) {
                consoleIntervalId = setInterval(addLine, 50);
                toggleConsoleBtn.textContent = 'Detener Consola';
            }
        }

        // Detiene la generación de líneas
        function stopConsole() {
            if (consoleIntervalId !== null) {
                clearInterval(consoleIntervalId);
                consoleIntervalId = null;
                toggleConsoleBtn.textContent = 'Iniciar Consola';
            }
        }

        // Initialize Firebase
        window.onload = function () {
            if (Object.values(firebaseConfig).some(value => value === '...')) {
                authErrorEl.textContent = 'Error: No se han configurado las credenciales de Firebase. La aplicación no funcionará.';
                authErrorEl.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setupAuthListener();
                setupEventListeners();
                
                // Initialize 3D logo for auth panel
                const authLogoContainer = document.getElementById('logo-3d-container');
                if (authLogoContainer) {
                    createAndAnimateLogo(authLogoContainer);
                }

                // Inicia el efecto de consola en la pantalla principal
                startConsole();

            } catch (e) {
                authErrorEl.textContent = 'Error al inicializar Firebase. Revisa tus credenciales.';
                authErrorEl.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                console.error("Error initializing Firebase:", e);
            }
        };

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (!auth.currentUser && initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            if (error.code !== 'auth/custom-token-mismatch') {
                                console.error("Error signing in with custom token:", error);
                            }
                        }
                    }
                    userId = user.uid;
                    userIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
                    authPanel.classList.add('hidden');
                    mainPanel.classList.remove('hidden');
                    setupRealtimeListener();
                    renderCalendar();
                } else {
                    userId = null;
                    authPanel.classList.remove('hidden');
                    mainPanel.classList.add('hidden');
                }
            });
        }
        
        // Firebase Auth functions
        async function handleAuth(e) {
            e.preventDefault();
            authErrorEl.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                authErrorEl.textContent = 'Por favor, introduce correo y contraseña.';
                authErrorEl.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                if (isLoginState) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    showMessageModal('Cuenta Creada', 'Por favor, verifica tu correo electrónico para iniciar sesión.');
                    authForm.reset();
                    toggleAuthMode();
                }
            } catch (error) {
                authErrorEl.textContent = getAuthErrorMessage(error.code);
                authErrorEl.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'El correo electrónico no es válido.';
                case 'auth/user-not-found':
                    return 'No se encontró una cuenta con ese correo.';
                case 'auth/wrong-password':
                    return 'Contraseña incorrecta.';
                case 'auth/email-already-in-use':
                    return 'Este correo ya está registrado.';
                case 'auth/weak-password':
                    return 'La contraseña debe tener al menos 6 caracteres.';
                case 'auth/network-request-failed':
                    return 'Error de conexión. Revisa tu conexión a internet.';
                default:
                    return `Ocurrió un error inesperado. Por favor, inténtalo de nuevo.`;
            }
        }

        function toggleAuthMode() {
            isLoginState = !isLoginState;
            authForm.reset();
            authErrorEl.classList.add('hidden');
            if (isLoginState) {
                authTitleEl.textContent = 'Iniciar Sesión';
                authBtn.textContent = 'Iniciar Sesión';
                toggleAuthBtn.textContent = 'Crear cuenta';
                authPanel.classList.remove('lcars-panel-create');
                document.querySelector('#authPanel h1').classList.remove('lcars-text-create');
                document.querySelector('#authPanel h1').classList.add('lcars-text');
                authBtn.classList.remove('lcars-btn-create');
                authBtn.classList.add('lcars-btn');
                emailInput.classList.remove('lcars-input-create');
                passwordInput.classList.remove('lcars-input-create');
                forgotPasswordBtn.classList.remove('hidden');
            } else {
                authTitleEl.textContent = 'Crear Cuenta';
                authBtn.textContent = 'Crear Cuenta';
                toggleAuthBtn.textContent = '¿Ya tienes una cuenta? Iniciar sesión';
                authPanel.classList.add('lcars-panel-create');
                document.querySelector('#authPanel h1').classList.remove('lcars-text');
                document.querySelector('#authPanel h1').classList.add('lcars-text-create');
                authBtn.classList.remove('lcars-btn');
                authBtn.classList.add('lcars-btn-create');
                emailInput.classList.add('lcars-input-create');
                passwordInput.classList.add('lcars-input-create');
                forgotPasswordBtn.classList.add('hidden');
            }
        }

        async function handleForgotPassword() {
            authErrorEl.classList.add('hidden');
            const email = emailInput.value;
            if (!email) {
                showMessageModal('Error', 'Por favor, ingresa tu correo para restablecer la contraseña.');
                return;
            }
            loadingIndicator.classList.remove('hidden');
            try {
                await sendPasswordResetEmail(auth, email);
                showMessageModal('Correo Enviado', 'Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.');
            } catch (error) {
                showMessageModal('Error', getAuthErrorMessage(error.code));
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function logout() {
            signOut(auth).catch((error) => {
                console.error("Error al cerrar sesión:", error);
            });
        }

        // Real-time listener for patients collection
        function setupRealtimeListener() {
            if (!db || !userId) return;
            onSnapshot(patientsRef(userId), (snapshot) => {
                patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPatientList(patients);
                updatePatientSuggestions();
                renderCalendar();
                if (selectedPatientId) {
                    const patient = patients.find(p => p.id === selectedPatientId);
                    if (patient) {
                        renderPatientDetails(patient);
                    } else {
                        selectedPatientId = null;
                        closePatientDetails();
                    }
                }
            }, (error) => {
                console.error("Error al escuchar los datos del paciente:", error);
                // Updated error message to be more descriptive for the user
                showMessageModal('Error de Permisos', 'No se pudieron cargar los datos. Esto puede deberse a que no tienes los permisos para acceder a esta información. Intenta recargar la página o volver a iniciar sesión.');
            });
        }

        function updatePatientSuggestions() {
            patientSuggestionsEl.innerHTML = '';
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = `${patient.name} ${patient.lastName || ''} - ${patient.city || 'N/A'}`;
                patientSuggestionsEl.appendChild(option);
            });
        }

        // Render functions
        function renderPatientList(patientList) {
            patientListEl.innerHTML = '';
            // Sort patients by last entry date, most recent first
            const sortedPatients = patientList.sort((a, b) => (b.lastEntry || 0) - (a.lastEntry || 0));
            sortedPatients.forEach(patient => {
                const li = document.createElement('li');
                li.className = 'bg-[#55446f] p-3 rounded-2xl shadow-sm cursor-pointer hover:bg-[#6b588a] transition-colors flex justify-between items-center border-2 border-[#a37dfd]';
                const lastEntryDate = patient.lastEntry ? new Date(patient.lastEntry).toLocaleDateString('es-CO') : 'Sin entradas';
                li.innerHTML = `
                    <span class="font-semibold text-[#ff9100]">${patient.name} ${patient.lastName || ''}</span>
                    <span class="text-xs text-[#a37dfd]">${lastEntryDate}</span>
                `;
                li.dataset.id = patient.id;
                li.addEventListener('click', () => selectPatient(patient.id));
                patientListEl.appendChild(li);
            });
        }

        function renderPatientDetails(patient) {
            patientNameEl.textContent = `${patient.name} ${patient.lastName || ''}`;
            patientInfoEl.innerHTML = `
                <p><strong>Fecha de Nacimiento:</strong> ${patient.dob} (${patient.age || 'N/A'})</p>
                <p><strong>Dirección:</strong> ${patient.address || 'N/A'}</p>
                <p><strong>Ciudad de Residencia:</strong> ${patient.city || 'N/A'}</p>
                <p><strong>Contacto:</strong> ${patient.contact || 'N/A'}</p>
                <p><strong>Lugar de Nacimiento:</strong> ${patient.birthplace || 'N/A'}</p>
                <p><strong>Antecedentes Patológicos:</strong> ${patient.history?.pathological || 'N/A'}</p>
                <p><strong>Antecedentes Familiares:</strong> ${patient.history?.family || 'N/A'}</p>
                <p><strong>Antecedentes Farmacológicos:</strong> ${patient.history?.pharmacological || 'N/A'}</p>
                <p><strong>Antecedentes Quirúrgicos:</strong> ${patient.history?.surgical || 'N/A'}</p>
                <p><strong>Enfermedad Actual:</strong> ${patient.currentIllness || 'N/A'}</p>
                <p><strong>Tratamientos:</strong> ${patient.treatments || 'N/A'}</p>
                <p><strong>Análisis:</strong> ${patient.analysis || 'N/A'}</p>
            `;
            
            patientNotesEl.innerHTML = '';
            if (patient.notes && patient.notes.length > 0) {
                // Sort notes by timestamp, most recent first
                const sortedNotes = patient.notes.sort((a, b) => b.timestamp - a.timestamp);
                sortedNotes.forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = `p-3 rounded-2xl ${note.isPriority ? 'bg-[#f57c00] border border-[#ef6c00]' : 'bg-[#4b3d68]'}`;
                    noteDiv.innerHTML = `
                        <p class="text-sm text-white">${note.text}</p>
                        <p class="text-xs text-[#a37dfd] mt-1">${new Date(note.timestamp).toLocaleString()}</p>
                        ${note.isPriority ? '<p class="text-xs text-white font-semibold mt-1">Nota Prioritaria</p>' : ''}
                    `;
                    patientNotesEl.appendChild(noteDiv);
                });
            } else {
                patientNotesEl.innerHTML = '<p class="text-[#a37dfd]">No hay notas para este paciente.</p>';
            }

            patientAttachmentsEl.innerHTML = '';
            if (patient.attachments && patient.attachments.length > 0) {
                patient.attachments.forEach(attachment => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.className = 'p-3 rounded-2xl bg-[#4b3d68] border-2 border-[#a37dfd]';
                    attachmentDiv.innerHTML = `
                        <a href="${attachment.url}" target="_blank" class="text-cyan-400 hover:text-cyan-200 transition-colors font-semibold flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2h2v1H6V6zm2 4H6v1h2v-1zm2 4H6v1h2v-1zm4-4h-2v1h2v-1zm0 4h-2v1h2v-1z" clip-rule="evenodd" />
                            </svg>
                            <span>${attachment.name}</span>
                        </a>
                    `;
                    patientAttachmentsEl.appendChild(attachmentDiv);
                });
            } else {
                patientAttachmentsEl.innerHTML = '<p class="text-[#a37dfd]">No hay archivos adjuntos para este paciente.</p>';
            }

            patientAppointmentsEl.innerHTML = '';
            if (patient.appointments && patient.appointments.length > 0) {
                // Sort appointments by date, most recent first
                const sortedAppointments = patient.appointments.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                sortedAppointments.forEach(appointment => {
                    const apptDiv = document.createElement('div');
                    apptDiv.className = 'p-3 rounded-2xl bg-[#4b3d68] border-2 border-[#a37dfd] text-white';
                    apptDiv.innerHTML = `
                        <p><strong>Fecha:</strong> ${appointment.date}</p>
                        <p class="text-xs text-[#a37dfd]">Agendada: ${new Date(appointment.timestamp).toLocaleString()}</p>
                    `;
                    patientAppointmentsEl.appendChild(apptDiv);
                });
            } else {
                patientAppointmentsEl.innerHTML = '<p class="text-[#a37dfd]">No hay citas agendadas.</p>';
            }
            
            aiClinicalSummarySection.classList.add('hidden');
            aiPatientSummarySection.classList.add('hidden');
            aiQuickSummaryEl.textContent = 'Generando resumen...';

            patientDetailsPanel.classList.remove('hidden');
            patientsPanel.classList.add('hidden');
            calendarPanel.classList.add('hidden');
            newPatientFormPanel.classList.add('hidden');
        }

        function closePatientDetails() {
            selectedPatientId = null;
            patientDetailsPanel.classList.add('hidden');
            patientsPanel.classList.remove('hidden');
            setActiveTab(tabPatientsBtn);
        }

        // Logic
        function selectPatient(patientId) {
            selectedPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                renderPatientDetails(patient);
                generateQuickSummary();
            }
        }

        async function savePatient(e) {
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');
            const patientData = {
                name: patientNameInput.value,
                lastName: patientLastNameInput.value,
                dob: patientDobInput.value,
                age: calculateAge(patientDobInput.value),
                address: patientAddressInput.value,
                city: patientCityInput.value,
                contact: patientContactInput.value,
                birthplace: patientBirthplaceInput.value,
                history: {
                    pathological: patientPathologicalHistoryInput.value,
                    family: patientFamilyHistoryInput.value,
                    pharmacological: patientPharmacologicalHistoryInput.value,
                    surgical: patientSurgicalHistoryInput.value
                },
                currentIllness: patientCurrentIllnessInput.value,
                treatments: patientTreatmentsInput.value,
                analysis: patientAnalysisInput.value,
            };

            // Implementar la lógica de tiempo de espera de 5 segundos
            const savePromise = new Promise(async (resolve, reject) => {
                try {
                    if (isEditing && selectedPatientId) {
                        const patientRef = doc(db, `artifacts/${appId}/users/${userId}/patients/${selectedPatientId}`);
                        await updateDoc(patientRef, patientData);
                    } else {
                        patientData.notes = [];
                        patientData.attachments = [];
                        patientData.appointments = [];
                        patientData.lastEntry = Date.now();
                        await addDoc(patientsRef(userId), patientData);
                    }
                    resolve();
                } catch (e) {
                    reject(e);
                }
            });

            const timeoutPromise = new Promise((resolve, reject) => {
                setTimeout(() => {
                    reject(new Error('timeout'));
                }, 5000); // 5 segundos
            });
            
            try {
                await Promise.race([savePromise, timeoutPromise]);
                showMessageModal('Éxito', `Paciente ${isEditing ? 'actualizado' : 'creado'} con éxito.`);
            } catch (e) {
                if (e.message === 'timeout') {
                    showMessageModal('Error de Conexión', 'La operación de guardado tardó demasiado. Por favor, verifica tu conexión a internet o las reglas de seguridad de Firestore.');
                } else {
                    console.error("Error saving patient:", e);
                    showMessageModal('Error', 'Hubo un problema al guardar el paciente. Revisa la consola para más detalles.');
                }
            } finally {
                loadingIndicator.classList.add('hidden');
                newPatientForm.reset();
                patientAgeDisplay.textContent = '';
                isEditing = false;
                formTitleEl.textContent = 'Añadir Nuevo Paciente';
                savePatientBtn.textContent = 'Guardar Paciente';
                setActiveTab(tabPatientsBtn);
            }
        }

        async function addNote() {
            const noteText = newNoteInput.value.trim();
            if (!noteText || !selectedPatientId) return;
            
            loadingIndicator.classList.remove('hidden');
            try {
                const patientRef = doc(db, `artifacts/${appId}/users/${userId}/patients/${selectedPatientId}`);
                const newNote = {
                    text: noteText,
                    timestamp: Date.now(),
                    isPriority: priorityNoteCheckbox.checked
                };
                const patientDoc = await getDoc(patientRef);
                const currentNotes = patientDoc.data().notes || [];
                const updatedNotes = [...currentNotes, newNote];
                await updateDoc(patientRef, { notes: updatedNotes, lastEntry: Date.now() });
                newNoteInput.value = '';
                priorityNoteCheckbox.checked = false;
            } catch (e) {
                console.error("Error adding note:", e);
                showMessageModal('Error', 'Hubo un problema al añadir la nota.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function addAttachment() {
            const file = attachmentFileInput.files[0];
            if (!file || !selectedPatientId) {
                showMessageModal('Error', 'Por favor, selecciona un archivo para subir.');
                return;
            }
            
            uploadProgress.classList.remove('hidden');
            progressBar.style.width = '0%';
            const fileName = file.name;
            const storagePath = `artifacts/${appId}/users/${userId}/patients/${selectedPatientId}/attachments/${fileName}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error("Error uploading file:", error);
                    uploadProgress.classList.add('hidden');
                    showMessageModal('Error de Subida', 'Hubo un problema al subir el archivo.');
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        const patientRef = doc(db, `artifacts/${appId}/users/${userId}/patients/${selectedPatientId}`);
                        const newAttachment = {
                            name: fileName,
                            url: downloadURL
                        };

                        const patientDoc = await getDoc(patientRef);
                        const currentAttachments = patientDoc.data().attachments || [];
                        const updatedAttachments = [...currentAttachments, newAttachment];

                        await updateDoc(patientRef, { attachments: updatedAttachments });
                        
                        attachmentFileInput.value = '';
                        uploadProgress.classList.add('hidden');
                        progressBar.style.width = '0%';
                        showMessageModal('Éxito', 'Archivo subido con éxito.');
                        
                    } catch (e) {
                        console.error("Error adding attachment URL:", e);
                        uploadProgress.classList.add('hidden');
                        showMessageModal('Error', 'Hubo un problema al guardar la URL del archivo.');
                    }
                }
            );
        }

        async function editPatient() {
            isEditing = true;
            formTitleEl.textContent = 'Editar Paciente';
            savePatientBtn.textContent = 'Actualizar Paciente';
            const patient = patients.find(p => p.id === selectedPatientId);
            if (patient) {
                patientNameInput.value = patient.name || '';
                patientLastNameInput.value = patient.lastName || '';
                patientDobInput.value = patient.dob || '';
                patientAgeDisplay.textContent = patient.age || '';
                patientAddressInput.value = patient.address || '';
                patientCityInput.value = patient.city || '';
                patientContactInput.value = patient.contact || '';
                patientBirthplaceInput.value = patient.birthplace || '';
                patientPathologicalHistoryInput.value = patient.history?.pathological || '';
                patientFamilyHistoryInput.value = patient.history?.family || '';
                patientPharmacologicalHistoryInput.value = patient.history?.pharmacological || '';
                patientSurgicalHistoryInput.value = patient.history?.surgical || '';
                patientCurrentIllnessInput.value = patient.currentIllness || '';
                patientTreatmentsInput.value = patient.treatments || '';
                patientAnalysisInput.value = patient.analysis || '';
                patientDetailsPanel.classList.add('hidden');
                patientsPanel.classList.add('hidden');
                calendarPanel.classList.add('hidden');
                newPatientFormPanel.classList.remove('hidden');
                tabPatientsBtn.classList.remove('active');
                tabCalendarBtn.classList.remove('active');
                tabNewPatientBtn.classList.add('active');
            } else {
                showMessageModal('Error', 'No se encontró el paciente para editar.');
            }
        }

        async function deletePatient() {
            deleteModal.classList.remove('hidden');
        }

        async function confirmDelete() {
            deleteModal.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            try {
                if (selectedPatientId) {
                    const patientRef = doc(db, `artifacts/${appId}/users/${userId}/patients/${selectedPatientId}`);
                    await deleteDoc(patientRef);
                    showMessageModal('Éxito', 'Paciente eliminado con éxito.');
                    closePatientDetails();
                }
            } catch (e) {
                console.error("Error deleting patient:", e);
                showMessageModal('Error', 'Hubo un problema al eliminar el paciente.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function cancelDelete() {
            deleteModal.classList.add('hidden');
        }

        function calculateAge(dob) {
            if (!dob) return '';
            const today = new Date();
            const birthDate = new Date(dob);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return `${age} años`;
        }

        // Logic for downloading files
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadSinglePatient() {
            if (!selectedPatientId) {
                showMessageModal('Error', 'Por favor, selecciona un paciente primero.');
                return;
            }

            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient) {
                showMessageModal('Error', 'Paciente no encontrado.');
                return;
            }

            const patientText = 
                `**Información del Paciente**\n` +
                `ID: ${patient.id}\n` +
                `Nombre: ${patient.name} ${patient.lastName || ''}\n` +
                `Fecha de Nacimiento: ${patient.dob || 'N/A'}\n` +
                `Edad: ${patient.age || 'N/A'}\n` +
                `Dirección: ${patient.address || 'N/A'}\n` +
                `Ciudad: ${patient.city || 'N/A'}\n` +
                `Contacto: ${patient.contact || 'N/A'}\n` +
                `Lugar de Nacimiento: ${patient.birthplace || 'N/A'}\n\n` +
                `**Antecedentes**\n` +
                `- Patológicos: ${patient.history?.pathological || 'N/A'}\n` +
                `- Familiares: ${patient.history?.family || 'N/A'}\n` +
                `- Farmacológicos: ${patient.history?.pharmacological || 'N/A'}\n` +
                `- Quirúrgicos: ${patient.history?.surgical || 'N/A'}\n\n` +
                `**Enfermedad Actual**: ${patient.currentIllness || 'N/A'}\n` +
                `**Tratamientos**: ${patient.treatments || 'N/A'}\n` +
                `**Análisis**: ${patient.analysis || 'N/A'}\n\n` +
                `**Notas**\n` +
                (patient.notes?.map(note => `[${new Date(note.timestamp).toLocaleString()}] ${note.isPriority ? '[PRIORITARIO] ' : ''}${note.text}`).join('\n') || 'No hay notas.');

            const filename = `Paciente_${patient.name.replace(/ /g, '_')}_${patient.lastName.replace(/ /g, '_')}.txt`;
            downloadFile(patientText, filename, 'text/plain');
        }

        function downloadAllPatientsCSV() {
            if (patients.length === 0) {
                showMessageModal('Info', 'No hay pacientes para descargar.');
                return;
            }

            const headers = [
                'ID', 'Nombre', 'Apellido', 'Fecha de Nacimiento', 'Edad', 'Dirección', 'Ciudad', 'Contacto', 'Lugar de Nacimiento',
                'Antecedentes Patológicos', 'Antecedentes Familiares', 'Antecedentes Farmacológicos', 'Antecedentes Quirúrgicos',
                'Enfermedad Actual', 'Tratamientos', 'Análisis', 'Notas'
            ];

            const csvRows = [headers.join(',')];

            patients.forEach(patient => {
                const notesText = (patient.notes || []).map(note => 
                    `[${new Date(note.timestamp).toLocaleString()}] ${note.isPriority ? '[PRIORITARIO] ' : ''}${note.text}`
                ).join(' | ').replace(/"/g, '""');

                const row = [
                    patient.id,
                    `"${patient.name || ''}"`,
                    `"${patient.lastName || ''}"`,
                    `"${patient.dob || ''}"`,
                    `"${patient.age || ''}"`,
                    `"${patient.address || ''}"`,
                    `"${patient.city || ''}"`,
                    `"${patient.contact || ''}"`,
                    `"${patient.birthplace || ''}"`,
                    `"${patient.history?.pathological?.replace(/"/g, '""') || ''}"`,
                    `"${patient.history?.family?.replace(/"/g, '""') || ''}"`,
                    `"${patient.history?.pharmacological?.replace(/"/g, '""') || ''}"`,
                    `"${patient.history?.surgical?.replace(/"/g, '""') || ''}"`,
                    `"${patient.currentIllness?.replace(/"/g, '""') || ''}"`,
                    `"${patient.treatments?.replace(/"/g, '""') || ''}"`,
                    `"${patient.analysis?.replace(/"/g, '""') || ''}"`,
                    `"${notesText}"`
                ];
                csvRows.push(row.join(','));
            });

            downloadFile(csvRows.join('\n'), 'pacientes.csv', 'text/csv;charset=utf-8;');
        }

        // Calendar logic
        function renderCalendar() {
            const today = new Date();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();

            currentMonthYearEl.textContent = `${new Intl.DateTimeFormat('es-CO', { month: 'long' }).format(firstDayOfMonth)} ${currentYear}`;
            calendarGrid.innerHTML = '';

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('py-2');
                calendarGrid.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('py-2', 'rounded-full', 'cursor-pointer', 'hover:bg-[#4b3d68]', 'transition-colors', 'calendar-day');
                dayEl.textContent = day;
                const dateToCheck = new Date(currentYear, currentMonth, day).toISOString().slice(0, 10);
                const hasAppointment = patients.some(p => p.appointments && p.appointments.some(a => a.date === dateToCheck));
                if (hasAppointment) {
                    dayEl.classList.add('has-appointment');
                }
                
                dayEl.addEventListener('click', () => {
                    const appointmentsForDay = patients.flatMap(p => 
                        p.appointments?.filter(a => a.date === dateToCheck).map(a => 
                            `Cita para ${p.name} ${p.lastName} el ${a.date}`
                        ) || []
                    );
                    if (appointmentsForDay.length > 0) {
                        showMessageModal('Citas del Día', appointmentsForDay.join('\n'));
                    } else {
                        showMessageModal('Citas del Día', 'No hay citas agendadas para este día.');
                    }
                });
                calendarGrid.appendChild(dayEl);
            }
        }

        async function handleAppointmentForm(e) {
            e.preventDefault();
            loadingIndicator.classList.remove('hidden');
            const patientName = appointmentPatientInput.value.trim();
            const appointmentDate = appointmentDateInput.value;

            const patient = patients.find(p => `${p.name} ${p.lastName}`.toLowerCase() === patientName.toLowerCase());
            if (!patient) {
                showMessageModal('Error', 'Paciente no encontrado. Por favor, asegúrate de que el nombre sea correcto.');
                loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                const patientRef = doc(db, `artifacts/${appId}/users/${userId}/patients/${patient.id}`);
                const newAppointment = {
                    date: appointmentDate,
                    timestamp: Date.now()
                };
                const patientDoc = await getDoc(patientRef);
                const currentAppointments = patientDoc.data().appointments || [];
                const updatedAppointments = [...currentAppointments, newAppointment];
                await updateDoc(patientRef, { appointments: updatedAppointments, lastEntry: Date.now() });
                showMessageModal('Éxito', 'Cita agendada con éxito.');
                appointmentModal.classList.add('hidden');
                appointmentForm.reset();
            } catch (e) {
                console.error("Error al agendar la cita:", e);
                showMessageModal('Error', 'Hubo un problema al agendar la cita.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        addAppointmentFromCalendarBtn.addEventListener('click', () => {
            appointmentPatientInput.value = '';
            appointmentDateInput.value = '';
            appointmentModal.classList.remove('hidden');
        });
        
        addAppointmentFromPatientBtn.addEventListener('click', () => {
            if (!selectedPatientId) return;
            const patient = patients.find(p => p.id === selectedPatientId);
            if (patient) {
                appointmentPatientInput.value = `${patient.name} ${patient.lastName || ''}`;
                appointmentDateInput.value = '';
                appointmentModal.classList.remove('hidden');
            }
        });

        cancelAppointmentBtn.addEventListener('click', () => {
            appointmentModal.classList.add('hidden');
        });
        appointmentForm.addEventListener('submit', handleAppointmentForm);

        async function generateQuickSummary() {
            aiQuickSummaryEl.textContent = 'Generando resumen...';
            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient || (!patient.notes || patient.notes.length === 0) && (!patient.history && !patient.currentIllness && !patient.treatments && !patient.analysis)) {
                aiQuickSummaryEl.textContent = 'No hay suficiente información para generar un resumen rápido.';
                return;
            }

            const allNotes = (patient.notes || []).map(note => `${note.isPriority ? '[PRIORITARIO] ' : ''}${note.text}`).join('\n');
            const historyText = `Antecedentes Patológicos: ${patient.history?.pathological || 'N/A'}\nAntecedentes Familiares: ${patient.history?.family || 'N/A'}\nAntecedentes Farmacológicos: ${patient.history?.pharmacological || 'N/A'}\nAntecedentes Quirúrgicos: ${patient.history?.surgical || 'N/A'}\n`;
            const clinicalData = `Enfermedad Actual: ${patient.currentIllness || 'N/A'}\nTratamientos: ${patient.treatments || 'N/A'}\nAnálisis: ${patient.analysis || 'N/A'}\n`;

            const userQuery = `Basado en la siguiente información y las notas de este paciente, genera un resumen muy breve y conciso de su estado actual, lo más importante de su caso y cualquier pendiente o próxima acción. Información del caso: ${historyText}\n${clinicalData}\nNotas: ${allNotes}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Eres un asistente médico experto. Tu única tarea es analizar un caso de paciente y resumir los puntos más críticos y las tareas pendientes en un tono profesional y directo. Sé extremadamente breve y ve al grano." }]
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            if (!geminiApiKey) {
                 aiQuickSummaryEl.textContent = 'Error: No se encontró la clave de API de Gemini. Asegúrate de que la API está habilitada en tu proyecto de Firebase.';
                 console.error('Error: Gemini API key is missing.');
                 return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                     const errorText = await response.text();
                     console.error(`API Error: ${response.status} ${response.statusText}`, errorText);
                     if (response.status === 401) {
                         aiQuickSummaryEl.textContent = `Error de autenticación (401). La clave de la API de Gemini es incorrecta o no está habilitada.`;
                     } else {
                         aiQuickSummaryEl.textContent = `Error HTTP! estado: ${response.status}. Inténtalo de nuevo más tarde.`;
                     }
                     throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar el resumen.';
                aiQuickSummaryEl.textContent = text;
            } catch (error) {
                console.error("Error generating quick summary:", error);
                aiQuickSummaryEl.textContent = 'Error al generar el resumen. Por favor, inténtalo de nuevo más tarde.';
            }
        }

        async function generateClinicalSummary() {
            loadingIndicator.classList.remove('hidden');
            aiClinicalSummarySection.classList.remove('hidden');
            const aiClinicalSummaryEl = document.getElementById('aiClinicalSummary');
            aiClinicalSummaryEl.textContent = 'Generando resumen clínico detallado...';
            
            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient || (!patient.history && !patient.currentIllness && !patient.treatments && !patient.analysis)) {
                aiClinicalSummaryEl.textContent = 'No hay suficiente información para generar un resumen clínico.';
                loadingIndicator.classList.add('hidden');
                return;
            }

            const allNotes = (patient.notes || []).map(note => `- ${note.isPriority ? '[PRIORITARIO] ' : ''}${note.text}`).join('\n');
            const historyText = `Antecedentes Patológicos: ${patient.history?.pathological || 'N/A'}\nAntecedentes Familiares: ${patient.history?.family || 'N/A'}\nAntecedentes Farmacológicos: ${patient.history?.pharmacological || 'N/A'}\nAntecedentes Quirúrgicos: ${patient.history?.surgical || 'N/A'}\n`;
            const clinicalData = `Enfermedad Actual: ${patient.currentIllness || 'N/A'}\nTratamientos: ${patient.treatments || 'N/A'}\nAnálisis: ${patient.analysis || 'N/A'}\n`;

            const userQuery = `Basado en la siguiente información de un paciente, genera un resumen clínico detallado y estructurado. Debe incluir un resumen de los antecedentes, la enfermedad actual, los tratamientos y el análisis del caso. Toda la información debe ser directamente de los datos proporcionados.
            
            Información del paciente:
            Nombre: ${patient.name} ${patient.lastName || ''}
            Fecha de Nacimiento: ${patient.dob}
            Lugar de Nacimiento: ${patient.birthplace || 'N/A'}
            Ciudad de Residencia: ${patient.city || 'N/A'}
            Contacto: ${patient.contact || 'N/A'}

            Antecedentes:
            - Patológicos: ${patient.history?.pathological || 'N/A'}
            - Familiares: ${patient.history?.family || 'N/A'}
            - Farmacológicos: ${patient.history?.pharmacological || 'N/A'}
            - Quirúrgicos: ${patient.history?.surgical || 'N/A'}
            
            Enfermedad Actual:
            ${patient.currentIllness || 'N/A'}
            
            Tratamientos:
            ${patient.treatments || 'N/A'}
            
            Análisis:
            ${patient.analysis || 'N/A'}
            
            Notas adicionales del caso:
            ${allNotes || 'No hay notas.'}
            `;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Eres un médico experimentado y tu única tarea es generar resúmenes clínicos detallados y estructurados. Debes utilizar un lenguaje formal y profesional, y apegarte estrictamente a la información proporcionada. No inventes ni añadas información. El resumen debe estar bien organizado con títulos y viñetas." }]
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

             if (!geminiApiKey) {
                aiClinicalSummaryEl.textContent = 'Error: No se encontró la clave de API de Gemini. Asegúrate de que la API está habilitada en tu proyecto de Firebase.';
                console.error('Error: Gemini API key is missing.');
                loadingIndicator.classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                     console.error(`API Error: ${response.status} ${response.statusText}`, errorText);
                     if (response.status === 401) {
                         aiClinicalSummaryEl.textContent = `Error de autenticación (401). La clave de la API de Gemini es incorrecta o no está habilitada.`;
                     } else {
                         aiClinicalSummaryEl.textContent = `Error HTTP! estado: ${response.status}. Inténtalo de nuevo más tarde.`;
                     }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar el resumen clínico.';
                aiClinicalSummaryEl.textContent = text;
            } catch (error) {
                console.error("Error generating clinical summary:", error);
                aiClinicalSummaryEl.textContent = 'Error al generar el resumen clínico. Por favor, inténtalo de nuevo más tarde.';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function generatePatientSummary() {
            loadingIndicator.classList.remove('hidden');
            aiPatientSummarySection.classList.remove('hidden');
            const aiPatientSummaryEl = document.getElementById('aiPatientSummary');
            aiPatientSummaryEl.textContent = 'Generando resumen para el paciente...';

            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient || (!patient.currentIllness && !patient.treatments)) {
                aiPatientSummaryEl.textContent = 'No hay suficiente información para generar un resumen para el paciente.';
                loadingIndicator.classList.add('hidden');
                return;
            }

            const userQuery = `Eres un asistente médico y tu tarea es explicarle a un paciente su condición médica de manera clara, simple y empática. Debes usar un lenguaje sencillo, no médico, y un tono tranquilizador.
            
            Información del paciente:
            Nombre: ${patient.name}
            Enfermedad Actual: ${patient.currentIllness || 'No especificada'}
            Tratamientos: ${patient.treatments || 'No especificados'}

            Notas adicionales del caso (para tu referencia, no para ser mostradas al paciente):
            Antecedentes Patológicos: ${patient.history?.pathological || 'N/A'}
            Notas del médico: ${(patient.notes || []).map(note => note.text).join('\n') || 'No hay notas.'}

            Genera un resumen para el paciente, en primera persona, como si fueras su médico, explicando de manera sencilla su situación de salud, los tratamientos que debe seguir y cualquier recomendación importante.
            `;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Eres un asistente médico experto. Tu única tarea es explicarle a un paciente su condición de manera clara, simple y empática. Debes utilizar un lenguaje sencillo, no médico, y un tono tranquilizador. Evita el uso de jerga. Preséntalo como una nota del médico al paciente." }]
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

             if (!geminiApiKey) {
                aiPatientSummaryEl.textContent = 'Error: No se encontró la clave de API de Gemini. Asegúrate de que la API está habilitada en tu proyecto de Firebase.';
                console.error('Error: Gemini API key is missing.');
                loadingIndicator.classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                     console.error(`API Error: ${response.status} ${response.statusText}`, errorText);
                     if (response.status === 401) {
                         aiPatientSummaryEl.textContent = `Error de autenticación (401). La clave de la API de Gemini es incorrecta o no está habilitada.`;
                     } else {
                         aiPatientSummaryEl.textContent = `Error HTTP! estado: ${response.status}. Inténtalo de nuevo más tarde.`;
                     }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar el resumen para el paciente.';
                aiPatientSummaryEl.textContent = text;
            } catch (error) {
                console.error("Error generating patient summary:", error);
                aiPatientSummaryEl.textContent = 'Error al generar el resumen para el paciente. Por favor, inténtalo de nuevo más tarde.';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function setActiveTab(activeButton) {
            const tabs = [tabPatientsBtn, tabCalendarBtn, tabNewPatientBtn];
            const panels = [patientsPanel, calendarPanel, newPatientFormPanel];

            tabs.forEach(tab => tab.classList.remove('active'));
            panels.forEach(panel => panel.classList.add('hidden'));

            activeButton.classList.add('active');
            
            if (activeButton === tabPatientsBtn) {
                patientsPanel.classList.remove('hidden');
                patientDetailsPanel.classList.add('hidden');
            } else if (activeButton === tabCalendarBtn) {
                calendarPanel.classList.remove('hidden');
                patientDetailsPanel.classList.add('hidden');
            } else if (activeButton === tabNewPatientBtn) {
                newPatientFormPanel.classList.remove('hidden');
                patientDetailsPanel.classList.add('hidden');
            }
        }

        // Event listeners
        function setupEventListeners() {
            authForm.addEventListener('submit', handleAuth);
            toggleAuthBtn.addEventListener('click', toggleAuthMode);
            forgotPasswordBtn.addEventListener('click', handleForgotPassword);
            
            tabPatientsBtn.addEventListener('click', () => setActiveTab(tabPatientsBtn));
            tabCalendarBtn.addEventListener('click', () => setActiveTab(tabCalendarBtn));
            tabNewPatientBtn.addEventListener('click', () => {
                isEditing = false;
                formTitleEl.textContent = 'Añadir Nuevo Paciente';
                savePatientBtn.textContent = 'Guardar Paciente';
                newPatientForm.reset();
                patientAgeDisplay.textContent = '';
                setActiveTab(tabNewPatientBtn);
            });
            cancelNewPatientBtn.addEventListener('click', () => setActiveTab(tabPatientsBtn));

            savePatientBtn.addEventListener('click', savePatient);
            patientDobInput.addEventListener('change', () => {
                patientAgeDisplay.textContent = calculateAge(patientDobInput.value);
            });
            addNoteBtn.addEventListener('click', addNote);
            addAttachmentBtn.addEventListener('click', addAttachment);
            editPatientBtn.addEventListener('click', editPatient);
            deletePatientBtn.addEventListener('click', deletePatient);
            confirmDeleteBtn.addEventListener('click', confirmDelete);
            cancelDeleteBtn.addEventListener('click', cancelDelete);
            generateClinicalSummaryBtn.addEventListener('click', generateClinicalSummary);
            generatePatientSummaryBtn.addEventListener('click', generatePatientSummary);
            
            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPatients = patients.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.lastName || '').toLowerCase().includes(searchTerm) ||
                    (p.city || '').toLowerCase().includes(searchTerm)
                );
                renderPatientList(filteredPatients);
            });

            // Event listeners for download buttons
            document.getElementById('downloadAllPatientsBtn').addEventListener('click', downloadAllPatientsCSV);
            document.getElementById('downloadSinglePatientBtn').addEventListener('click', downloadSinglePatient);
            toggleConsoleBtn.addEventListener('click', () => {
                if (consoleIntervalId === null) {
                    startConsole();
                } else {
                    stopConsole();
                }
            });

            // Logic for collapsible history section
            toggleHistoryBtn.addEventListener('click', () => {
                const isHidden = historySection.classList.toggle('hidden');
                if (isHidden) {
                    historyArrow.style.transform = 'rotate(0deg)';
                } else {
                    historyArrow.style.transform = 'rotate(180deg)';
                }
            });

            logoutBtn.addEventListener('click', logout);
            
            // Re-apply event listeners after they are re-added to the DOM
            // This is not necessary with the new tabbed layout as the buttons are persistent
        }
    </script>
</body>
</html>
